# Available Actions

The work performed by a [Task](tasks.md) or LRP is expressed in terms of composable Actions.

The following actions are available.  The details are presented below:

- [`RunAction`](#runaction): runs a process in the container
- [`DownloadAction`](#downloadaction): fetches an archive (`.tgz` or `.zip`) and extracts it into the container
- [`UploadAction`](#uploadaction): uploads a single file, in the container, to a URL via POST
- [`ParallelAction`](#parallelaction): runs multiple actions in parallel.
- [`CodependentAction`](#codependentaction): runs multiple actions in parallel and exits all actions after any action exits
- [`SerialAction`](#serialaction): runs multiple actions in order.
- [`EmitProgressAction`](#emitprogressaction): wraps another action and logs messages when the wrapped action begins and ends.
- [`TimeoutAction`](#timeoutaction): fails if the wrapped action does not exit within a time interval.
- [`TryAction`](#tryaction): runs the wrapped action but ignores errors generated by the wrapped action.

## `RunAction`

The run action runs a process in the container:

```go
action := &models.RunAction{
  Path: "/path/to/executable",
  Args: []string{"some", "args to", "pass in"},
  Dir: "/path/to/working/directory",
  EnvironmentVariables: []*models.EnvironmentVariable{
    {
      Name: "ENVNAME",
      Value: "ENVVALUE",
    },
  },
  ResourceLimits: &models.ResourceLimits{
    Nofile: 1000,
  },
  User: "username",
  LogSource: "some-log-source",
}
```

#### `Path` [required]

The path to the executable.

#### `Dir` [optional]

The working directory in which to execute the process.

#### `Args` [optional]

An array of command line arguments for the executable.

#### `Env` [optional]

A list of environment variables. These are applied on top of any
container-level environment variables.

#### `ResourceLimits` [optional]

A set of constraints to apply to the process.  Currently only file descriptor
limits (`Nofile`) are enforceable.

#### `User` [required]

The user that runs the action. Running as 'root' may be disabled by the
operator managing Diego. If it is disabled, the `RunAction` will fail.  If the
associated Task/LRP has the container-level `Privileged` flag set to `true`
then this will correspond to *real* root, otherwise the process will be run as
a user-namespaced root.

#### `LogSource` [optional]

If provided, logs emitted by this process will be tagged with the provided
`LogSource`.  Otherwise the container-level `LogSource` is used.

## `DownloadAction`

The download action downloads an archive and extracts it to a specified
location:

```go
action := &models.DownloadAction{
  Artifact: "download name"
  From: "http://some/endpoint",
  To: "/some/container/path",
  User: "username",
  CacheKey: "some-cache-key",
  LogSource: "some-log-source",
}
```

#### `Artifact` [optional]

If specified, additional logs will be emitted to signify the progress of the
download action including the bytes downloaded.

#### `From` [required]

The url from which to fetch the archive.  The downloaded asset must be a
gzipped tarball, or a zip archive.

#### `To` [required]

The absolute path to extract the archive into.

#### `User` [required]

The user that downloads the artifact. Running as 'root' may be disabled by the
operator managing Diego. If it is disabled, the `DownloadAction` will fail.  If
the associated Task/LRP has the container-level `privileged` flag set to `true`
then this will correspond to *real* root, otherwise the download will be run as
a user-namespaced root.

#### `CacheKey` [optional]

If specified, Diego will cache the downloaded asset.    The cached downloaded
user ETag and LastModified headers to invalidate the cache.

#### `LogSource` [optional]

If provided, logs emitted by this action will be tagged with the provided
`LogSource`.  Otherwise the container-level `LogSource` is used.

## `UploadAction`

The upload action uploads a file to the specified location:

```go
action := &models.UploadAction{
  Artifact: "upload name"
  To: "http://some/endpoint",
  From: "/some/container/file",
  User: "username",
  LogSource: "some-log-source",
}
```

#### `Artifact` [optional]

If specified, additional logs will be emitted to signify the progress of the
upload action including the bytes uploaded.

#### `From` [required]

The absolute path to a *file* in the container.

#### `To` [required]

A URL to upload the file to.  The upload will be an HTTP POST.

#### `User` [required]

The user that uploads the artifact. Running as 'root' may be disabled by the
operator managing Diego. If it is disabled, the `UploadAction` will fail.  If
the associated Task/LRP has the container-level `privileged` flag set to `true`
then this will correspond to *real* root, otherwise the upload will be run as a
user-namespaced root.

#### `LogSource` [optional]

If provided, logs emitted by this action will be tagged with the provided
`LogSource`.  Otherwise the container-level `LogSource` is used.

## `SerialAction`

```go
action := &models.SerialAction{
  Actions: []*models.Action{
    action1,
    action2,
  },
  LogSource: "log-source",
}
```

#### `Actions` [required]

An array of embedded actions to run.  The actions are run in series.

If an action fails the serial action returns with the failure.  Subsequent
actions are not run.

#### `LogSource` [optional]

If provided, logs emitted by this action and its subactions will be tagged with
the provided `LogSource`.  Otherwise the container-level `LogSource` is used.

## `ParallelAction`

```go
action := &models.ParallelAction{
  Actions: []*models.Action{
    action1,
    action2,
  },
  LogSource: "log-source",
}
```

#### `Actions` [required]

An array of embedded actions to run.  The actions are run in parallel.

The parallel action returns after all actions have returned.  The parallel
action errors if any of the actions error, returning the first error it sees.

#### `LogSource` [optional]

If provided, logs emitted by this action and its subactions will be tagged with
the provided `LogSource`.  Otherwise the container-level `LogSource` is used.

## `CodependentAction`

```go
action := &models.CodependentAction{
  Actions: []*models.Action{
    action1,
    action2,
  },
  LogSource: "log-source",
}
```

#### `Actions` [required]

An array of embedded actions to run.  The actions are run in parallel.

The codependent action returns after any action exits.  The codependent action
always errors as it is intended to run indefinitely.

#### `LogSource` [optional]

If provided, logs emitted by this action and its subactions will be tagged with
the provided `LogSource`.  Otherwise the container-level `LogSource` is used.

## `EmitProgressAction`

```go
action := &models.EmitProgressAction{
  Action: differentAction,
  StartMessage: "some message",
  SuccessMessage: "some message",
  FailureMessagePrefix: "some message",
  LogSource: "some-log-source",
}
```

#### `Action` [required]

The action to run.

#### `StartMessage` [optional]

If present, a message to emit before the action runs.

#### `SuccessMessage` [optional]

If present, a message to emit when the action succeeds.

#### `FailureMessagePrefix` [optional]

If present, a message to emit when the action fails. The corresponding error if
emittable will be appended with a ':' separator.

#### `LogSource` [optional]

If provided, logs emitted by this action and its subaction will be tagged with
the provided `LogSource`.  Otherwise the container-level `LogSource` is used.

## `TimeoutAction`

```go
action := &models.TimeoutAction{
  Action: differentAction,
  Timeout: int64(10 * time.Second),
  LogSource: "log-source",
}
```

#### `Action` [required]

The action to run.

#### `Timeout` [required]

The number of nanoseconds (1 second = 1e9 nanoseconds) to wait before giving up
on the action and failing.  `timeout` must be greater than `0`.

#### `LogSource` [optional]

If provided, logs emitted by this action and its subaction will be tagged with
the provided `LogSource`.  Otherwise the container-level `LogSource` is used.

## `TryAction`

```go
action := &model.TryAction{
  Action: differentAction,
  LogSource: "some-log-source",
}
```

#### `Action` [required]

The action to run.  Errors generated by the action are swallowed by the
`TryAction`.

#### `LogSource` [optional]

If provided, logs emitted by this action and its subaction will be tagged with
the provided `LogSource`.  Otherwise the container-level `LogSource` is used.

[back](README.md)
